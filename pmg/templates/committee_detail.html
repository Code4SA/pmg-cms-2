{% extends "committee_layout.html" %}
{% from 'macros/members.html' import member_badge %}

{% block committee_title %}
  <h1>{{ committee.name }}</h1>
  <h4 class="light-red">{{ committee.house.name }} Committee</h4>
{% endblock %}

{% block committee_page %}
  <div class="row">
    <div class="col-md-8">
      {% if committee.about %}
        <h3 class="collapse-link"><span class="fa fa-caret-right"></span> <a href="#">About this committee</a></h3>
        <div class="collapse">
          {{ committee.about|safe }}
        </div>
      {% endif %}

      <nav class="c-m-nav" id="c-m-nav">
        <ul class="nav nav-tabs">
          <li class="active"><a href="#cm" data-toggle="tab">Committee meetings</a></li>
          <li><a href="#cc" data-toggle="tab">Calls for comment</a></li>
          <li><a href="#tr" data-toggle="tab">Tabled reports</a></li>
          <li><a href="#qr" data-toggle="tab">Questions/replies</a></li>
        </ul>
      </nav>

      <div class="c-m-mobile">
        <nav class="c-m-nav-mobile" id="c-m-nav-mobile">
          <div class="dropdown">
            <button type="button" class="btn btn-default" data-toggle="dropdown">Sections <span class="carat"></span></button>
            <ul class="dropdown-menu">
              <li><a href="#cm" data-toggle="tab">Committee meetings</a></li>
              <li><a href="#cc" data-toggle="tab">Calls for comment</a></li>
              <li><a href="#tr" data-toggle="tab">Tabled reports</a></li>
              <li><a href="#qr" data-toggle="tab">Questions/replies</a></li>
            </ul>
          </div>
        </nav>

        <div class="c-m-filter-mobile">
          <div class="dropdown">
            <button type="button" class="btn btn-default" data-toggle="dropdown">Filter by date</button>
            <ul class="dropdown-menu">
              <li>
                <a href="#" data-filter="recent" data-year="{{ current_year }}">Recent meetings</a>
                <a href="#" data-filter="six-months" data-year="{{ current_year }}">Last 6 months</a>
                <a href="#" data-year="{{ current_year }}">This year</a>
                {% for year in range(2012,current_year) | reverse %}
                  <a href="#" data-year="{{ year }}">{{ year }}</a>
                {% endfor %}
              </li>
            </ul>
          </div>
        </div>
      </div>

      <div class="tab-content">
        <div class="tab-pane fade in active c-m-list" id="cm">
          <div class="c-m-filter-wrapper">
            <div class="btn-group c-m-filter">
              <button type="button" class="btn btn-default active" data-filter="recent" data-year="{{ current_year }}">Recent meetings</button>
              <button type="button" class="btn btn-default" data-filter="six-months" data-year="{{ current_year }}">Last 6 months</button>
              <button type="button" class="btn btn-default" data-year="{{ current_year }}">This year</button>
              {% for year in range(2012,current_year) | reverse %}
                <button type="button" class="btn btn-default" data-year="{{ year }}">{{ year }}</button>
              {% endfor %}
            </div>
          </div>
          <div class="c-m-list">
            {% for year, meetings in meetings_by_year.iteritems() %}
              {% if year == current_year %}
              <table class="table table-striped" id="m-{{ year }}">
              {% else %}
              <table class="table table-striped" style="display:none;" id="m-{{ year }}">
              {% endif %}
                {% for meeting in meetings %}
                  <tr data-date="{{ meeting.date | pretty_date }}">
                    <td><nobr>{{ meeting.date | pretty_date }}</nobr></td>
                    {% if meeting.id %}
                      <td><a href="{{ url_for('committee_meeting', event_id=meeting.id) }}">{{ meeting.title }}</a></td>
                    {% else %}
                      <td>{{ meeting.title }}</td>
                    {% endif %}
                  </tr>
                {% endfor %}
              </table>
            {% endfor %}
          </div>
        </div>
        <div class="tab-pane fade in c-m-t-reports" id="tr">
          {% if tabled_committee_reports %}
            <table class="table table-striped">
              {% for item in tabled_committee_reports[0:5] %}
              <tr>
                <td><a href="{{ url_for('tabled_committee_report', tabled_committee_report_id=item.id) }}">{{ item.title }}</a></td>
                </div>
              </tr>
              {% endfor %}
            </table>

            {% if tabled_committee_reports|length > 5 %}
              <a href="{{ url_for('tabled_committee_reports', **{'filter[committee]': committee.id}) }}" class="btn btn-primary">More</a>
            {% endif %}
          {% endif %}
        </div>
        <div class="tab-pane fade in c-m-c-comment" id="cc">
          {% if calls_for_comments %}
            <table class="table table-striped">
              {% for item in calls_for_comments[0:5] %}
                <tr><td>
                  <div class="row">
                    <div class="col-xs-4">{{ item.start_date|pretty_date }}</div>
                    <div class="col-xs-8"><a href="{{ url_for('call_for_comment', call_for_comment_id=item.id) }}">{{ item.title }}</a></div>
                  </div>
                </td></tr>
              {% endfor %}
            </table>

            {% if calls_for_comments|length > 5 %}
              <a href="/calls-for-comments/?filter[committee]={{ committee.id }}" class="btn btn-primary">More</a>
            {% endif %}
          {% endif %}
        </div>
        <div class="tab-pane fade in c-m-q-replies" id="qr">
          {% if recent_questions %}
            <table class="table table-striped">
              {% for item in recent_questions %}
                <tr><td>
                  <div class="row">
                    <div class="col-xs-4">{{ (item.start_date or item.date)|pretty_date }}</div>
                    <div class="col-xs-8">
                      {# handle QuestionReply and CommitteeQuestion objects differently #}
                      {% if item.date %}
                      <a href="{{ url_for('committee_question', question_id=item.id) }}">{{ item.asked_by_name }}</a>
                      {% else %}
                      <a href="{{ url_for('question_reply', question_reply_id=item.id) }}">{{ item.title }}</a>
                      {% endif %}
                    </div>
                  </div>
                </td></tr>
              {% endfor %}
            </table>
            <a href="{{ url_for('question_replies', **{'filter[committee]': committee.id}) }}" class="btn btn-primary">More</a>
          {% endif %}
        </div>
    </div> <!-- /Reports -->

    <div class="col-md-4">
      <h3><span class="fa fa-group"></span> Members</h3>
      {% if committee.memberships %}
        {% set break = 0.5 * committee.memberships | length %}
        {% set break = break | int %}
        <div class="row">
          <div class="col-sm-12">
            <ul class="list-unstyled list-spaced">

              {% for membership in committee.memberships %}
                {% set member = membership.member %}
                {% if membership.type == 'chairperson'%}
                  <li class="clearfix">{{ member_badge(member, chairperson=True) }}</li>
                  <hr>
                {% endif %}
              {% endfor %}
            </ul>
          </div>
        </div>

        <div class="row">
          <div class="col-sm-6">
            <ul class="list-unstyled list-spaced">
              {% for membership in committee.memberships[0:break] %}
                {% set member = membership.member %}
                {% if not membership.type or membership.type != 'chairperson'%}
                  <li class="clearfix">{{ member_badge(member) }}</li>
                {% endif %}
              {% endfor %}
            </ul>
          </div>
          <div class="col-sm-6">
            <ul class="list-unstyled list-spaced">
              {% for membership in committee.memberships[break::] %}
                {% set member = membership.member %}
                {% if not membership.type or membership.type != 'chairperson'%}
                  <li class="clearfix">{{ member_badge(member) }}</li>
                {% endif %}
              {% endfor %}
            </ul>
          </div>
        </div>
      {% else %}
        <p class="lead">We don't have membership info for this committee.</p>
      {% endif %}

      {% if committee.contact_details %}
        <h3><span class="fa fa-envelope"></span> Contact</h3>
        {{ committee.contact_details|safe }}
      {% endif %}

    </div>  <!-- /Members -->
  </div>
{% endblock %}
